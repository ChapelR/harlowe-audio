/**
 * Harlowe Audio Library (HAL), by Chapel, v2.0.0-pre1
 * for Harlowe 2.1.0 and higher
 * Released under the Unlicense, and dedicated to the public domain.
**/
;window.Chapel=window.Chapel||{},window.Chapel.options={preload:!0,loadDelay:0,muteOnBlur:!0,startingVol:.5,persistPrefs:!0,globalA:!0,showControls:!0,sidebarStartClosed:!0,volumeDisplay:!0,trackLoadLimit:500,totalLoadLimit:8e3},function(){"use strict";var t=$("tw-storydata"),e=t.find('tw-passagedata[name="hal.tracks"]'),o=null;if(e.length){var n=e.text().split(/[\n\r]/).filter(function(e){return e&&e.trim()&&e.includes(":")});o=new Map(n.map(function(e){var t=e.split(":");if(2<t.length){var o=t.slice(1,t.length).join(":");t[1]=o,t.length=2}var n=t[0].trim();return[n=(n=(n=n.replace(/^["']/,"")).replace(/["']$/,"")).trim(),t[1].split(",").map(function(e){return e=(e=(e=(e=e.trim()).replace(/^["']/,"")).replace(/["']$/,"")).trim()})]}))}var r=t.find('tw-passagedata[name="hal.config"]'),i=null;if(r.length){var a=r.text().split(/[\n\r]/).filter(function(e){return e&&e.trim()&&e.includes(":")}),s={};a.map(function(e){var t=e.split(":"),o=t[0].trim();o=(o=(o=o.replace(/^["']/,"")).replace(/["']$/,"")).trim();var n=t[1].trim();return[o,n=(n=(n=n.replace(/^["']/,"")).replace(/["']$/,"")).trim().toLowerCase()]}).forEach(function(e){s[e[0]]=e[1]}),i=s}function u(){var e=t.attr("format-version").split(".")[0];return e=Number(e),Number.isNaN(e)&&(e=3),e<1&&(e=3),e}if(i&&Object.keys(i).forEach(function(e){var t=e,o=s[e],n=typeof Chapel.options[e];"boolean"==n?"true"===o?Chapel.options[t]=!0:"false"===o&&(Chapel.options[t]=!1):"number"==n?(o=Number(o),Number.isNaN(o)||(Chapel.options[t]=o)):"string"==n&&o&&(Chapel.options[t]=o)}),window.Chapel=window.Chapel||{},window.Chapel.Get={version:u(),isHarlowe3OrLater:3<=u(),storyTitle:t.attr("name"),IFID:t.attr("ifid"),fromPassage:o},Chapel.Get.version<2)throw new Error("The Harlowe Audio Library is only designed to work with Harlowe 2 and 3; you appear to be using Harlowe 1 or an otherwise invalid story format.");Chapel.options.storagekey="%%hal-"+Chapel.Get.IFID+"-{"+Chapel.Get.storyTitle+"}";var l=require("macros");window.Chapel.Macros={add:function(t){t&&"object"==typeof t&&Object.keys(t).forEach(function(e){!function(e,o){l.add(e,function(){var e=[].slice.call(arguments).slice(1),t=o.apply(null,e);return"string"==typeof t||"boolean"==typeof t||"number"==typeof t?t:""},l.TypeSignature.zeroOrMore(l.TypeSignature.Any))}(e,t[e])})}}}(),function(){"use strict";var r=Chapel.options,t=$(document.createElement("div")).attr("id","audio-container").css("display","none").appendTo(document.body),e=function(e,t){if(window.localStorage)try{e=""+e,"string"!=typeof t&&(t=JSON.stringify(t)),window.localStorage.setItem(e,t)}catch(e){console.error(e)}},o=function(e){if(window.localStorage)try{return e=""+e,window.localStorage.getItem(e)}catch(e){console.error(e)}},n=function(e){if(window.localStorage)try{e=""+e,window.localStorage.removeItem(e)}catch(e){console.error(e)}};function i(t,o){if("object"!=typeof t||"object"!=typeof o)throw new Error("Invalid extension.");Object.keys(o).forEach(function(e){if(void 0!==t[e])throw new Error('Invalid extension: cannot clobber existing property "'+e+'"');t[e]=o[e]})}var a={loaded:[],classes:{},master:{volume:r.startingVol,mute:!1},groups:{playing:[],looping:[],custom:{}},mute:function(e){a.master.mute=!!e,$(document).trigger({type:":master-mute",mute:!!e})},isMuted:function(){return!!a.master.mute},volume:function(e){e=Number(e),Number.isNaN(e)||(1<e?e=1:e<0&&(e=0),a.master.volume=e),$(document).trigger({type:":master-volume",volume:e})},getVolume:function(){return a.master.volume},stopAll:function(){c.list.forEach(function(e){e.stop()})},audioPlaying:function(){return!!a.groups.playing.length},savePrefs:function(){e(r.storagekey,a.master)},loadPrefs:function(){var e=o(r.storagekey);e&&"object"==typeof e&&e.hasOwnProperty("volume")&&"number"==typeof e.volume&&e.hasOwnProperty("mute")&&"boolean"==typeof e.volume&&(delete a.master,a.master=e)},clearPrefs:function(){n(r.storagekey)}},s={track:[":available",":loaded",":play",":stop",":mute",":volume"],master:[":master-mute",":master-volume"]},u={aac:"audio/aac",caf:"audio/x-caf","x-caf":"audio/x-caf",mp3:'audio/mpeg; codecs="mp3"',mpeg:'audio/mpeg; codecs="mp3"',m4a:"audio/mp4",mp4:"audio/mp4","x-m4a":"audio/mp4","x-mp4":"audio/mp4",oga:"audio/ogg",ogg:"audio/ogg",opus:'audio/ogg; codecs="opus"',wav:"audio/wav",wave:"audio/wav",weba:"audio/webm",webm:"audio/webm"};function l(e){throw new Error(e)}function c(e,t,o){this instanceof c||l("Track: called without `new` operator"),e||l("Track: no id specified"),"string"!=typeof e&&l("Track: track id is not a string"),t&&(!Array.isArray(t)||t.length)||l("Track: no sources specified"),o&&(t=[].slice.call(arguments).slice(1));var n=$(document.createElement("audio"));t.forEach(function(e){$(document.createElement("source")).attr({src:e,type:function(e){var t=e.split("."),o=t[t.length-1];return o.includes("?")&&(o=o.split("?")[0]),o=o.toLowerCase().trim(),Object.keys(u).includes(o)||l('Track: unsupported file type "'+o+'"'),u[o]}(e)}).appendTo(n)}),n.attr({"data-track":"id","data-volume":1,"data-mute":!1}).one("canplay",function(){a.loaded.push(e)}),r.preload&&n.attr("preload","auto"),n[0].volume=1*a.master.volume,this.id=e,this.$el=n,this.unwrap=n[0],this.sources=t}Object.assign(c,{list:[],is:function(e){return e instanceof c},has:function(t){return c.list.some(function(e){return e.id===t})},emit:function(e,t){$(document).trigger({type:e,track:t}),t.emit(e)},add:function(e,t,o){o&&(t=[].slice.call(arguments).slice(1));var n=new c(e,t);return c.list.push(n),n.$el.on("canplay",function(){c.emit(":available",n)}),n.$el.on("canplaythrough",function(){c.emit(":loaded",n)}),n.attach(),n},renew:function(){c.list.forEach(function(e){e.mute(e.isMuted()),e.volume(e.getVolume())})},getIdx:function(t){return c.list.findIndex(function(e){return e.id===t})},get:function(t){return c.list.find(function(e){return e.id===t})},extend:function(e){i(c,e)},extendPrototype:function(e){i(c.prototype,e)},removeFromDOM:function(e){"string"==typeof e&&(e=c.get(e)),e&&c.is(e)?e.unattach():t.remove()}}),Object.assign(c.prototype,{constructor:c,emit:function(e){this.$el.trigger({type:e,track:this})},clone:function(){return new c(this.id,this.sources)},isAttached:function(){return $.contains(t[0],this.unwrap)},attach:function(){return this.isAttached()||this.$el.appendTo(t),this},unattach:function(){return this.isAttached()&&this.$el.remove(),this},isPlaying:function(){return!this.unwrap.paused},play:function(){var e=this;return this.unwrap.play(),c.emit(":play",this),this.$el.on("ended",function(){e.unwrap.loop||(e.unwrap.currentTime=0,c.emit(":stop",e))}),this},playWhenPossible:function(){var t=this;return this.unwrap.play().then(function(){c.emit(":play",t),t.$el.on("ended",function(){t.unwrap.loop||(t.unwrap.currentTime=0,c.emit(":stop",t))})},function(e){$(document).one("click mousedown keydown touchstart",function(){t.play()})}).catch(function(e){console.error(e)}),this},forcePlay:function(){var e=this,t=$(document.createElement("a")).css("display","none").appendTo(document.body).on("click",function(){e.play()});setTimeout(function(){t.trigger("click")},100)},pause:function(){return this.unwrap.pause(),c.emit(":pause",this),this},stop:function(){return this.unwrap.pause(),this.unwrap.currentTime=0,c.emit(":stop",this),this},mute:function(e){return e=!!e,this.$el.attr("data-mute",e),a.master.mute?this.unwrap.muted=!0:this.unwrap.muted=e,c.emit(":mute",this),this},isMuted:function(){var e=this.$el.attr("data-mute");return"boolean"==typeof e?e:"false"!==e},toggleMute:function(){return this.mute(!this.isMuted()),this},volume:function(e){return e=Number(e),Number.isNaN(e)||(1<e?e=1:e<0&&(e=0),this.$el.attr("data-volume",e),this.unwrap.volume=e*a.master.volume),c.emit(":volume",this),this},getVolume:function(){return Number(this.$el.attr("data-volume"))},addToGroup:function(e,t){var o=this,n=t?a.groups.custom[e]:a.groups[e];return n.some(function(e){return o.id===e.id})||n.push(this),this},removeFromGroup:function(e,t){var o=this,n=t?a.groups.custom[e]:a.groups[e],r=n.findIndex(function(e){return e.id&&e.id===o.id});return n.splice(r,1),this},loop:function(e){return this.unwrap.loop=!!e,this.unwrap.loop?this.addToGroup("looping"):this.removeFromGroup("looping"),this},isLooping:function(){return!!this.unwrap.loop},toggleLoop:function(){return this.loop(!this.isLooping()),this},seek:function(e){return e<0?e=this.unwrap.duration-e:e>this.unwrap.duration&&(e=this.unwrap.duration),this.unwrap.currentTime=e,this},fadeIn:function(e){var t=this;e=e||1;var o=this.getVolume();return this.volume(0),this.play(),this.$el.animate({volume:o*a.master.volume},1e3*e,function(){t.volume(o),c.emit(":volume",t),c.emit(":fade",t)}),this},fadeOut:function(e){e=e||1;var t=this,o=this.getVolume();return this.$el.animate({volume:0},1e3*e,function(){t.stop(),t.volume(o),c.emit(":volume",t),c.emit(":fade",t)}),this},fadeTo:function(e,t){var o=this;if(e=e||1,t=Number(t),!Number.isNaN(t))return 1<t?t=1:t<0&&(t=0),this.$el.animate({volume:t*a.master.volume},1e3*e,function(){o.volume(t),c.emit(":volume",o),c.emit(":fade",o)}),this;alert("ivalid volume level")},delay:function(e,t){var o=this;"function"==typeof t&&(e=Number(e),(Number.isNaN(e)||e<0)&&(e=0),setTimeout(function(){t.call(o,o,e)},e))},on:function(e,t){return t&&"function"==typeof t?(":"!==(e=e.trim().toLowerCase())[0]&&(e=":"+e),s.track.includes(e)?void this.$el.on(e,t):(console.error("<track>.on() -> invalid event type"),this)):(console.error("<track>.on() -> invalid callback"),this)},one:function(e,t){return t&&"function"==typeof t?(":"!==(e=e.trim().toLowerCase())[0]&&(e=":"+e),s.track.includes(e)?void this.$el.one(e,t):(console.error("<track>.one() -> invalid event type"),this)):(console.error("<track>.one() -> invalid callback"),this)}});var p=s.track.concat(s.master);function d(e,t){if(!(this instanceof d))return new d(e,t);this.id=e,this.tracks=t.map(function(e){return c.get(e)}),this.looping=!1,this.current="",this.playing=!1}a.on=function(e,t){t&&"function"==typeof t?(":"!==(e=e.trim().toLowerCase())[0]&&(e=":"+e),p.includes(e)?$(document).on(e,t):console.error("Chapel.Audio.on() -> invalid event type")):console.error("Chapel.Audio.on() -> invalid callback")},a.one=function(e,t){t&&"function"==typeof t?(":"!==(e=e.trim().toLowerCase())[0]&&(e=":"+e),p.includes(e)?$(document).one(e,t):console.error("Chapel.Audio.one() -> invalid event type")):console.error("Chapel.Audio.one() -> invalid callback")},a.on(":master-mute",c.renew),a.on(":master-volume",c.renew),r.persistPrefs&&(a.on(":master-mute",a.savePrefs),a.on(":master-volume",a.savePrefs)),a.on(":play",function(e){e.track.addToGroup("playing")}),a.on(":stop",function(e){e.track.removeFromGroup("playing")}),r.muteOnBlur&&$(window).on("blur",function(){a.isMuted()||(a.mute(!0),$(window).one("focus",function(){a.mute(!1)}))}),a.classes.Track=c,a.newTrack=function(){try{return c.add.apply(null,arguments)}catch(e){console.error(e.message),alert("Error in A.newTrack() -> see the console for more information.")}},a.track=function(e){try{return c.get(e)}catch(e){console.error(e.message),alert("Error in A.track() -> see the console for more information.")}},a.createGroup=function(e,t,o){!function(e,t){t&&Array.isArray(t)||(t=[]),a.groups.custom[e]=t.map(function(e){return c.get(e)})}(e,o?[].slice.call(arguments).slice(1):t)},a.group=function(e){if(!(this instanceof a.group))return new a.group(e);Object.keys(a.groups.custom).includes(e)?this.members=a.groups.custom[e]:this.members=a.groups[e],Array.isArray(this.members)||(this.members=[],console.error('Could not find members for track group "'+e+'"!'))},Object.assign(a.group,{is:function(e){return this instanceof a.group},runOnAll:function(e,t,o){e.members.forEach(function(e){e[t].apply(e,o&&Array.isArray(o)?o:[])})},extend:function(e){i(a.group,e)},extendPrototype:function(e){i(a.group.prototype,e)}}),Object.assign(a.group.prototype,{constructor:a.group,run:function(e,t,o){null!=o&&(t=[].slice.call(arguments).slice(1)),c.prototype.hasOwnProperty(e)&&a.group.runOnAll(this,e,t)},play:function(){return this.run("play"),this},pause:function(){return this.run("pause"),this},stop:function(){return this.run("stop"),this},mute:function(e){return this.run("mute",[e]),this},volume:function(e){return this.run("volume",[e]),this},loop:function(e){return this.run("loop",[e]),this}}),Object.assign(d,{list:{},is:function(e){return e instanceof d},add:function(e,t,o){return o&&(t=[].slice.call(arguments).slice(1)),d.list[e]=new d(e,t),d.list[e]},extend:function(e){i(d,e)},extendPrototype:function(e){i(d.prototype,e)}}),Object.assign(d.prototype,{constructor:d,clone:function(){return new d(this.id,this.tracks.map(function(e){return e.id}))},shuffle:function(){var e,t,o,n=this.tracks;for(o=n.length-1;0<o;o--)e=Math.floor(Math.random()*(o+1)),t=n[o],n[o]=n[e],n[e]=t;return this.tracks=n,this},random:function(){return this.tracks[Math.floor(Math.random()*this.tracks.length)]},isPlaying:function(){return this.playing},play:function(e){var t=this;if((e=e||(t.current?t.tracks.findIndex(function(e){return e.id===t.current}):0))>=t.tracks.length&&t.looping)e=0;else if(e>=t.tracks.length)return t.current="",void(t.playing=!1);var o=t.tracks[e],n=o.isLooping();return o.loop(!1),o.play(),t.playing=!0,setTimeout(function(){o.isPlaying()||(t.playing=!1)},20),t.current=o.id,o.$el.one("ended.playlist",function(){e++,o.loop(n),t.play(e)}),t},loop:function(e){return this.looping=!!e,this},isLooping:function(){return this.looping},stop:function(){var e=c.get(this.current);return e.stop(),e.$el.off(".playlist"),this.current="",this.playing=!1,this},pause:function(){return c.get(this.current).pause(),this.playing=!1,this}}),a.classes.Playlist=d,a.createPlaylist=function(){try{d.add.apply(null,arguments)}catch(e){console.error(e.message),alert("Error in A.createPlaylist() -> see the console for more information.")}},a.playlist=function(e){try{var t=d.list[e]||null;if(!t)throw new Error('Playlist "'+e+'" does not exist.');return t}catch(e){console.error(e.message),alert("Error in A.createPlaylist() -> see the console for more information.")}},a.extend=function(e){i(a,e)},a.extendTrack=c.extend,a.extendTrackProto=c.extendPrototype,a.extendGroup=a.group.extend,a.extendGroupProto=a.group.extendPrototype,a.extendPlaylist=d.extend,a.extendPlaylistProto=d.extendPrototype,window.Chapel=window.Chapel||{},window.Chapel.Audio=a}(),function(){"use strict";var e=Chapel.options;if(e.showControls){var t=$(document.createElement("div")).attr("id","story-menu").css("display","none"),o=$(document.createElement("span")).attr("id","vol-title").append("Volume");e.volumeDisplay||o.css("display","none");var n=$(document.createElement("input")).attr({id:"audio-volume",type:"range",min:1,max:99,step:1,title:"Volume"}),r=Math.trunc(100*window.Chapel.Audio.master.volume);r<0?r=0:100<r&&(r=100),n.attr("value",r);var i=function(e){void 0===e&&(e=n.val()),o.empty().append("Volume "+e)};n.on("input",function(){window.Chapel.Audio.volume($(this).val()/100),i($(this).val())});var a=$(document.createElement("tw-link")).attr({id:"audio-mute",title:"Mute"}).append("Mute <span></span>").on("click",function(e){e.preventDefault(),$(this).toggleClass("muted"),Chapel.Audio.mute(!Chapel.Audio.isMuted())});Chapel.Audio.isMuted()&&a.addClass("muted");var s=$(document.createElement("tw-link")).attr("id","audio-panel-toggle").on("click",function(e){e.preventDefault(),u.toggleClass("closed")}),u=$(document.createElement("div")).attr("id","audio-controls").append(t,o,n,a,s).appendTo(document.body);e.sidebarStartClosed&&u.addClass("closed"),window.Chapel=window.Chapel||{},window.Chapel.Audio=window.Chapel.Audio||{},window.Chapel.Audio.controls={$panel:u,$volume:n,$mute:a,$user:t,close:function(){u.addClass("closed")},open:function(){u.removeClass("closed")},toggle:function(){u.toggleClass("closed")},hide:function(){u.css("display","none")},show:function(){u.css("display","block")},updateVolume:i}}}(),function(e){(jQuery.browser=jQuery.browser||{}).mobile=/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4))}(navigator.userAgent||navigator.vendor||window.opera),function(){"use strict";var s=Chapel.options,t=State,e=$(document.createElement("div")).attr("id","audio-overlay").css("display","none").appendTo(document.body);function o(){e.css("display","block").append('<div class="lds-ring"><div></div><div></div><div></div><div></div></div>')}function u(){e.fadeOut(function(){e.empty()})}window.Chapel=window.Chapel||{},window.Chapel.Audio=window.Chapel.Audio||{},window.Chapel.Audio.loadScreen={show:o,dismiss:u,kill:function(){$("#audio-overlay").remove()}},window.Chapel.Audio.$overlay=e,window.Chapel.Audio.preload=function(){if(!(t.pastLength||t.futureLength||$.browser.mobile)){$(document).ready(function(){o()});var r=100+s.loadDelay,e=Chapel.Audio.classes.Track.list,i=Chapel.Audio.loaded;if(e.length){var a=e.map(function(e){return e.id});0<s.totalLoadLimit&&setTimeout(function(){u()},s.totalLoadLimit),function e(){if(a.length){var t=a.shift();if(i.includes(t))e();else{var o=Chapel.Audio.classes.Track.get(t);if(o.unwrap.readyState<2){var n=!1;o.$el.one("canplay",function(){e(),n=!0}),setTimeout(function(){n||(o.$el.off("canplay"),e())},s.trackLoadLimit)}else i.includes(t)||i.push(t),e()}}else setTimeout(u,r)}()}else setTimeout(u,r)}}}(),function(){"use strict";var e,t,o=Chapel.options.storagekey+"_hal_restart_",n=(window.sessionStorage?(e=function(e,t){window.sessionStorage.setItem(o+e,t)},t=function(e){return window.sessionStorage.getItem(o+e)}):(e=function(){},t=function(){},console.warn("Session storage is unavailable...")),{save:e,load:t});window.Chapel.Audio.state={_store:n,saveTracks:function(){var e;try{e=Chapel.Audio.classes.Track.list.map(function(e){return{id:e.id,sources:e.sources}}),e=JSON.stringify(e),n.save("tracks",e)}catch(e){console.error(e.message)}},loadTracks:function(){var e;try{e=(e=n.load("tracks"))&&JSON.parse(e),Array.isArray(e)&&e.length&&e.forEach(function(e){e.id&&e.sources&&!Chapel.Audio.classes.Track.has(e.id)?Chapel.Audio.newTrack.apply(null,[e.id].concat(e.sources)):console.warn("Track reload failed...")})}catch(e){console.error(e.message)}},savePlaylists:function(){var e;try{var o=Chapel.Audio.classes.Playlist.list;e=Object.keys(o).map(function(e){var t={};return t.tracks=o[e].tracks.map(function(e){return e.id}),t.id=o[e].id,t}),e=JSON.stringify(e),n.save("playlists",e)}catch(e){console.error(e.message)}},loadPlaylists:function(){var e;try{(e=(e=n.load("playlists"))&&JSON.parse(e))&&Array.isArray(e)&&e.length&&e.forEach(function(e){e.id&&e.tracks&&Chapel.Audio.createPlaylist(e.id,e.tracks)})}catch(e){console.error(e.message)}},saveGroups:function(){var t;try{t={},Object.keys(Chapel.Audio.groups.custom).forEach(function(e){t[e]=Chapel.Audio.groups.custom[e].map(function(e){return"string"==typeof e?e:e.id})}),t=JSON.stringify(t),n.save("groups",t)}catch(e){console.error(e.message)}},loadGroups:function(){var t;try{(t=(t=n.load("groups"))&&JSON.parse(t))&&"object"==typeof t&&(Object.keys(t).forEach(function(e){t[e].map(function(e){return Chapel.Audio.classes.Track.get(e)})}),Chapel.Audio.groups.custom=t)}catch(e){console.error(e.message)}}}}(),function(){"use strict";var e=Chapel.options;e.globalA&&void 0===window.A&&(window.A=window.Chapel.Audio),Chapel.Get.fromPassage&&Chapel.Get.fromPassage.forEach(function(e,t){Chapel.Audio.newTrack.apply(null,[t].concat(e))}),$(document).on("unload",function(){window.Chapel.Audio.savePrefs()}),Chapel.Audio.classes.Track.renew(),Chapel.Audio.controls&&Chapel.Audio.controls.updateVolume(),Chapel.Get.isHarlowe3OrLater&&($(window).on("unload",function(){Chapel.Audio.state.saveTracks(),Chapel.Audio.state.savePlaylists(),Chapel.Audio.state.saveGroups()}),Chapel.Audio.state.loadTracks(),Chapel.Audio.state.loadPlaylists(),Chapel.Audio.state.loadGroups()),e.persistPrefs&&Chapel.Audio.loadPrefs()}(),function(){"use strict";if(Chapel.options.showControls){var s=Engine,u=Chapel.Audio.controls.$user,e=function(){return"none"!==u.css("display")},l=function(){return e()||u.css("display","block"),u},t=function(){return e()&&u.css("display","none"),u};Chapel.Audio.menu={hide:t,show:l,isShown:e,links:{add:function(e,t,o){var n,r;if(!e||"string"!=typeof e){var i="undefined";return alert(i),void console.error(i)}o||"function"!=typeof t?(t&&"string"==typeof t&&(n=t),o&&"function"==typeof o&&(r=o)):(r=t,n=null);var a=$(document.createElement("tw-link")).append(e).attr({tabindex:"0",name:e.toLowerCase().trim()}).on("click",function(){n&&s.goToPassage(n),r&&r()}).addClass("story-menu").appendTo(u);return l(),a},clear:function(){return u.empty(),t()},hide:function(e){e=e.toLowerCase().trim(),$('tw-link.story-menu[name="'+e+'"]').addClass("hide")},show:function(e){e=e.toLowerCase().trim(),$('tw-link.story-menu[name="'+e+'"]').removeClass("hide")},toggle:function(e){e=e.toLowerCase().trim(),$('tw-link.story-menu[name="'+e+'"]').toggleClass("hide")},remove:function(e){e=e.toLowerCase().trim(),$('tw-link.story-menu[name="'+e+'"]').remove()}}}}}(),function(){"use strict";var n=Chapel.Audio;function o(e){return e&&"function"==typeof e}function r(e,t){if(!e||"string"!=typeof e)return null;switch(e=e.toLowerCase().trim()){case"isplaying":e="isPlaying";break;case"playwhenpossible":e="playWhenPossible";break;case"ismuted":e="isAMuted";break;case"togglemute":e="toggleMute";break;case"getvolume":e="getVolume";break;case"islooping":e="isLooping";break;case"toggleloop":e="toggleLoop";break;case"fadein":e="fadeIn";break;case"fadeout":e="fadeOut";break;case"fadeto":e="fadeTo";break;case"stopall":e="stopAll"}if("isPlaying"===e&&"master"===t&&(e="audioPlaying"),"group"===t){if(o(n.group.prototype[e]))return e}else if("master"===t){if(o(n[e]))return e}else if(o(n.classes[t].prototype[e]))return e;throw new Error('Cannot run the command: "'+e+'" on the API "'+t+'". The command may be invalid, or this may be a bug in HAL.')}var e={newtrack:function(){var e=[].slice.call(arguments);try{return n.newTrack.apply(null,e)}catch(e){alert("Error in the (newtrack:) macro: "+e.message)}},newplaylist:function(e,t){t=[].slice.call(arguments).slice(1);try{return n.createPlaylist(e,t)}catch(e){alert("Error in the (newplaylist:) macro: "+e.message)}},newgroup:function(e,t){t=[].slice.call(arguments).slice(1);try{return n.createGroup(e,t)}catch(e){alert("Error in the (newgroup:) macro: "+e.message)}},masteraudio:function(e){try{return e=r(e,"master"),n[e].apply(null,[].slice.call(arguments).slice(1))}catch(e){alert("Error in the (masteraudio:) macro: "+e.message)}},track:function(e,t){try{var o=n.track(e);return o[t=r(t,"Track")].apply(o,[].slice.call(arguments).slice(2))}catch(e){alert("Error in the (track:) macro: "+e.message)}},playlist:function(e,t){try{var o=n.playlist(e);return o[t=r(t,"Playlist")].apply(o,[].slice.call(arguments).slice(2))}catch(e){alert("Error in the (playlist:) macro: "+e.message)}},group:function(e,t){try{var o=n.group(e);return o[t=r(t,"group")].apply(o,[].slice.call(arguments).slice(2))}catch(e){alert("Error in the (group:) macro: "+e.message)}}};window.Chapel.Macros.add(e)}();
/** End of HAL code */