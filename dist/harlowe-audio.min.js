;(function () {
    /**
     * Harlowe Audio Library, by Chapel, v0.1.0pre
     *
     * Released under the Unlicense, and dedicated to the public domain.
    **/

    var options = {
        preload : true,
        loadDelay : 0,
        muteOnBlur : true,
        startingVol : 0.5,
        storagekey : '%%tw-audio',
        persistPrefs : true,
        globalA : true,
        includeFixes : false,
        controls : {
            show : true,
            startClosed : true
        }
    };

    !function(){"use strict";var t=function(t,e){if(window.localStorage)try{t=""+t,"string"!=typeof e&&(e=JSON.stringify(e)),window.localStorage.setItem(t,e)}catch(t){console.error(t)}},e=function(t){if(window.localStorage)try{return t=""+t,window.localStorage.getItem(t)}catch(t){console.error(t)}},n=function(t){if(window.localStorage)try{t=""+t,window.localStorage.removeItem(t)}catch(t){console.error(t)}},r={loaded:[],classes:{},master:{volume:options.startingVol,mute:!1},groups:{playing:[],looping:[],custom:{}},mute:function(t){r.master.mute=!!t,$(document).trigger({type:":master-mute",mute:!!t})},isMuted:function(){return!!r.master.mute},volume:function(t){t=Number(t),Number.isNaN(t)||(1<t?t=1:t<0&&(t=0),r.master.volume=t),$(document).trigger({type:":master-volume",volume:t})},getVolume:function(){return r.master.volume},stopAll:function(){s.list.forEach(function(t){t.stop()})},audioPlaying:function(){return!!r.groups.playing.length},savePrefs:function(){t(options.storagekey,r.master)},loadPrefs:function(){var t=e(options.storagekey);t&&"object"==typeof t&&t.hasOwnProperty("volume")&&"number"==typeof t.volume&&t.hasOwnProperty("mute")&&"boolean"==typeof t.volume&&(delete r.master,r.master=t)},clearPrefs:function(){n(options.storagekey)}},u={aac:"audio/aac",caf:"audio/x-caf","x-caf":"audio/x-caf",mp3:'audio/mpeg; codecs="mp3"',mpeg:'audio/mpeg; codecs="mp3"',m4a:"audio/mp4",mp4:"audio/mp4","x-m4a":"audio/mp4","x-mp4":"audio/mp4",oga:"audio/ogg",ogg:"audio/ogg",opus:'audio/ogg; codecs="opus"',wav:"audio/wav",wave:"audio/wav",weba:"audio/webm",webm:"audio/webm"};function a(t){throw new Error(t)}function s(t,e,n){this instanceof s||a("Track: called without `new` operator"),t||a("Track: no id specified"),"string"!=typeof t&&a("Track: track id is not a string"),(!e||Array.isArray(e)&&!e.length)&&a("Track: no sources specified"),n&&(e=[].slice.call(arguments).slice(1));var i=$(document.createElement("audio"));e.forEach(function(t){var e,n,o;$(document.createElement("source")).attr({src:t,type:(e=t,n=e.split("."),o=n[n.length-1],o.includes("?")&&(o=o.split("?")[0]),o=o.toLowerCase().trim(),Object.keys(u).includes(o)||a('Track: unsupported file type "'+o+'"'),u[o])}).appendTo(i)}),i.attr({"data-track":"id","data-volume":1,"data-mute":!1}).one("canplay",function(){r.loaded.push(t)}),options.preload&&i.attr("preload","auto"),i[0].volume=1*r.master.volume,this.id=t,this.$el=i,this.unwrap=i[0],this.sources=e}function o(t,e){if(!(this instanceof o))return new o(t,e);this.id=t,this.tracks=e.map(function(t){return s.get(t)}),this.looping=!1,this.current="",this.playing=!1}s.list=[],s.is=function(t){return t instanceof s},s.has=function(e){return s.list.some(function(t){return t.id===e})},s.emit=function(t,e){$(document).trigger({type:t,track:e}),e.emit(t)},s.add=function(t){var e=new s(t,[].slice.call(arguments).slice(1));return s.list.push(e),e.$el.on("canplay",function(){s.emit(":available",e)}),e.$el.on("canplaythrough",function(){s.emit(":loaded",e)}),e},s.renew=function(){s.list.forEach(function(t){t.mute(t.isMuted()),t.volume(t.getVolume())})},s.getIdx=function(e){return s.list.findIndex(function(t){return t.id===e})},s.get=function(e){return s.list.find(function(t){return t.id===e})},s.prototype={constructor:s,emit:function(t){this.$el.trigger({type:t,track:this})},clone:function(){return new s(this.id,this.sources)},attach:function(){return this.$audio.appendTo(document.body),this},unattach:function(){return this.$audio.remove(),this},isPlaying:function(){return!this.unwrap.paused},play:function(){var t=this;return this.unwrap.play(),s.emit(":play",this),this.$el.on("ended",function(){t.unwrap.loop||(t.unwrap.currentTime=0,s.emit(":stop",t))}),this},playWhenPossible:function(){var e=this;return this.unwrap.play().then(function(){s.emit(":play",e),e.$el.on("ended",function(){e.unwrap.loop||(e.unwrap.currentTime=0,s.emit(":stop",e))})},function(t){$(document).one("click mousedown keydown touchstart",function(){e.play()})}).catch(function(t){console.error(t)}),this},forcePlay:function(){var t=this,e=$(document.createElement("a")).css("display","none").appendTo(document.body).on("click",function(){t.play()});setTimeout(function(){e.trigger("click")},100)},pause:function(){return this.unwrap.pause(),s.emit(":pause",this),this},stop:function(){return this.unwrap.pause(),this.unwrap.currentTime=0,s.emit(":stop",this),this},mute:function(t){return t=!!t,this.$el.attr("data-mute",t),r.master.mute?this.unwrap.muted=!0:this.unwrap.muted=t,s.emit(":mute",this),this},isMuted:function(){var t=this.$el.attr("data-mute");return"boolean"==typeof t?t:"false"!==t},toggleMute:function(){return this.mute(!this.isMuted()),this},volume:function(t){return t=Number(t),Number.isNaN(t)||(1<t?t=1:t<0&&(t=0),this.$el.attr("data-volume",t),this.unwrap.volume=t*r.master.volume),s.emit(":volume",this),this},getVolume:function(){return Number(this.$el.attr("data-volume"))},addToGroup:function(t,e){var n=this,o=e?r.groups.custom[t]:r.groups[t];return o.some(function(t){return n.id===t.id})||o.push(this),this},removeFromGroup:function(t,e){var n=this,o=e?r.groups.custom[t]:r.groups[t],i=o.findIndex(function(t){return t.id&&t.id===n.id});return o.splice(i,1),this},loop:function(t){return this.unwrap.loop=!!t,this.unwrap.loop?this.addToGroup("looping"):this.removeFromGroup("looping"),this},isLooping:function(){return!!this.unwrap.loop},toggleLoop:function(){return this.loop(!this.isLooping()),this},seek:function(t){return t<0?t=this.unwrap.duration-t:t>this.unwrap.duration&&(t=this.unwrap.duration),this.unwrap.currentTime=t,this},fadeIn:function(t){var e=this;t=t||1;var n=this.getVolume();return this.volume(0),this.play(),this.$el.animate({volume:n*r.master.volume},1e3*t,function(){e.volume(n),s.emit(":volume",e),s.emit(":fade",e)}),this},fadeOut:function(t){t=t||1;var e=this,n=this.getVolume();return this.$el.animate({volume:0},1e3*t,function(){e.stop(),e.volume(n),s.emit(":volume",e),s.emit(":fade",e)}),this},fadeTo:function(t,e){t=t||1;this.getVolume();return e=Number(e),Number.isNaN(e)||(1<e?e=1:e<0&&(e=0)),this.volume(0),this.$el.animate({volume:target*r.master.volume},1e3*t,function(){s.emit(":volume",self),s.emit(":fade",self)}),this},delay:function(t,e){var n=this;"function"==typeof e&&(t=Number(t),(Number.isNaN(t)||t<0)&&(t=0),setTimeout(function(){e.call(n,n,t)},t))}},$(document).on(":master-mute",s.renew),$(document).on(":master-volume",s.renew),options.persistPrefs&&($(document).on(":master-mute",r.savePrefs),$(document).on(":master-volume",r.savePrefs)),$(document).on(":play",function(t){t.track.addToGroup("playing")}),$(document).on(":stop",function(t){t.track.removeFromGroup("playing")}),options.muteOnBlur&&$(window).on("blur",function(){r.isMuted()||(r.mute(!0),$(window).one("focus",function(){r.mute(!1)}))}),r.classes.Track=s,r.newTrack=s.add,r.track=function(t){return s.get(t)},r.createGroup=function(t,e,n){var o,i,u;o=n?[].slice.call(arguments).slice(1):e,i=t,(u=o)&&Array.isArray(u)||(u=[]),r.groups.custom[i]=u.map(function(t){return s.get(t)})},r.group=function(t){if(!(this instanceof r.group))return new r.group(t);Object.keys(r.groups.custom).includes(t)?this.members=r.groups.custom[t]:this.members=r.groups[t]},r.group.is=function(t){return this instanceof r.group},r.group.runOnAll=function(t,e,n){t.members.forEach(function(t){t[e].apply(t,n&&Array.isArray(n)?n:[])})},r.group.prototype={constructor:r.group,run:function(t,e,n){null!=n&&(e=[].slice.call(arguments).slice(1)),s.prototype.hasOwnProperty(t)&&r.group.runOnAll(this,t,e)},play:function(){return this.run("play"),this},pause:function(){return this.run("pause"),this},stop:function(){return this.run("stop"),this},mute:function(t){return this.run("mute",[t]),this},volume:function(t){return this.run("volume",[t]),this},loop:function(t){return this.run("loop",[t]),this}},o.list={},o.is=function(t){return t instanceof o},o.add=function(t,e,n){return n&&(e=[].slice.call(arguments).slice(1)),o.list[t]=new o(t,e),o.list[t]},o.prototype={constructor:o,clone:function(){return new o(this.id,this.tracks.map(function(t){return t.id}))},shuffle:function(){var t,e,n,o=this.tracks;for(n=o.length-1;0<n;n--)t=Math.floor(Math.random()*(n+1)),e=o[n],o[n]=o[t],o[t]=e;return this.tracks=o,this},random:function(){return this.tracks[Math.floor(Math.random()*this.tracks.length)]},isPlaying:function(){return this.playing},play:function(t){var e=this;if((t=t||(e.current?e.tracks.findIndex(function(t){return t.id===e.current}):0))>=e.tracks.length&&e.looping)t=0;else if(t>=e.tracks.length)return e.current="",void(e.playing=!1);var n=e.tracks[t];console.log(n.id,n);var o=n.isLooping();return n.loop(!1),n.play(),e.playing=!0,setTimeout(function(){n.isPlaying()||(e.playing=!1)},20),e.current=n.id,n.$el.one("ended.playlist",function(){t++,n.loop(o),e.play(t)}),e},loop:function(t){return this.looping=!!t,this},stop:function(){var t=s.get(this.current);return t.stop(),t.$el.off(".playlist"),this.current="",this.playing=!1,this},pause:function(){return s.get(this.current).pause(),this.playing=!1,this}},r.classes.Playlist=o,r.createPlaylist=o.add,r.playlist=function(t){return o.list[t]||null},window.Chapel=window.Chapel||{},window.Chapel.Audio=r,options.persistPrefs&&r.loadPrefs()}(),function(){"use strict";if(options.controls.show){var t=$(document.createElement("input")).attr({id:"audio-volume",type:"range",min:1,max:99,step:1}),e=Math.trunc(100*window.Chapel.Audio.master.volume);e<0?e=0:100<e&&(e=100),t.attr("value",e),t.on("input",function(){window.Chapel.Audio.volume($(this).val()/100)});var n=$(document.createElement("tw-link")).attr("id","audio-mute").append("Mute <span></span>").on("click",function(t){t.preventDefault(),$(this).toggleClass("muted"),Chapel.Audio.mute(!Chapel.Audio.isMuted())});Chapel.Audio.isMuted()&&n.addClass("muted");var o=$(document.createElement("tw-link")).attr("id","audio-panel-toggle").on("click",function(t){t.preventDefault(),i.toggleClass("closed")}),i=$(document.createElement("div")).attr("id","audio-controls").append(t,n,o).appendTo(document.body);options.controls.startClosed&&i.addClass("closed"),window.Chapel=window.Chapel||{},window.Chapel.Audio=window.Chapel.Audio||{},window.Chapel.Audio.controls={$panel:i,$volume:t,$mute:n,close:function(){i.addClass("closed")},open:function(){i.removeClass("closed")},toggle:function(){i.toggleClass("closed")},hide:function(){i.css("display","none")},show:function(){i.css("display","block")}}}}(),function(){"use strict";var e=State,t=$(document.createElement("div")).attr("id","audio-overlay").css("display","none").appendTo(document.body);function u(){t.css("display","block").append('<div class="lds-ring"><div></div><div></div><div></div><div></div></div>')}function r(){t.fadeOut(function(){t.empty()})}window.Chapel=window.Chapel||{},window.Chapel.Audio=window.Chapel.Audio||{},window.Chapel.Audio.loadScreen={show:u,dismiss:r,kill:function(){$("#audio-overlay").remove()}},window.Chapel.Audio.$overlay=t,window.Chapel.Audio.preload=function(){if(!e.pastLength&&!e.futureLength){$(document).ready(function(){u()});var n=100+options.loadDelay,t=Chapel.Audio.classes.Track.list,o=Chapel.Audio.loaded;if(t.length){var i=t.map(function(t){return t.id});!function t(){if(i.length){var e=i.shift();o.includes(e)?t():Chapel.Audio.classes.Track.get(e).$el.off("canplay").one("canplay",function(){t()})}else setTimeout(r,n)}()}else setTimeout(r,n)}}}(),function(){"use strict";options.globalA&&void 0===window.A&&(window.A=window.Chapel.Audio),$(document).on("unload",function(){window.Chapel.Audio.savePrefs()}),Chapel.Audio.classes.Track.renew()}(),function(){"use strict";var o=window.prompt;window.prompt=function(){var t,e,n=o.apply(null,[].slice.call(arguments));return t=n,e=(new DOMParser).parseFromString(t,"text/html"),Array.from(e.body.childNodes).some(function(t){return 1===t.nodeType})?n.replace(/[<>]/g,""):n}}();

}());